name: ios minimal lts (merge only)

on:
  workflow_dispatch: # 手动触发，产出最小化 LTS xcframework

jobs:
  build-ios-minimal-lts:
    name: ios minimal lts xcframework
    runs-on: macos-14
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: prerequisites
        run: brew install autoconf automake libtool pkg-config curl git cmake nasm

      - name: set up xcode (use runner default if requested version missing)
        env:
          XCODE_VERSION: 15.4
        run: |
          XCODE_PATH="/Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer"
          if [ -d "$XCODE_PATH" ]; then
            echo "export DEVELOPER_DIR=$XCODE_PATH" > ~/.xcode.for.ffmpeg.kit.sh
          else
            echo "Xcode ${XCODE_VERSION} not found, using default $(xcode-select -p)"
            > ~/.xcode.for.ffmpeg.kit.sh
          fi

      - name: build minimal lts xcframework (arm64 + arm64-simulator)
        run: |
          ./ios.sh --xcframework --lts \
            --disable-armv7 --disable-armv7s --disable-i386 --disable-x86-64 \
            --disable-arm64e --disable-arm64-mac-catalyst --disable-x86-64-mac-catalyst \
            --enable-ios-audiotoolbox --enable-ios-avfoundation --enable-ios-videotoolbox \
            --enable-ios-zlib --enable-ios-libiconv

      - name: upload minimal lts xcframework
        uses: actions/upload-artifact@v4
        with:
          name: ios-minimal-lts-xcframework
          path: |
            prebuilt/bundle-apple-xcframework-ios-lts/*.xcframework
            prebuilt/bundle-apple-xcframework-ios-lts/LICENSE*
          if-no-files-found: error
